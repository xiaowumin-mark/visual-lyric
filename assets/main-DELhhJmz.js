var F=Object.defineProperty;var G=(f,c,x)=>c in f?F(f,c,{enumerable:!0,configurable:!0,writable:!0,value:x}):f[c]=x;var E=(f,c,x)=>G(f,typeof c!="symbol"?c+"":c,x);import{g as y}from"./index-BpvWWeyl.js";(async()=>{function f(g){const e=new DOMParser(g,"application/xml").parseFromString(g,"text/xml").getElementsByTagName("body")[0].getElementsByTagName("div")[0].children;let t=[],s=0;for(let r=0;r<e.length;r++){const i=e[r];let n=c(i.getAttribute("begin"));t.length>0&&n-t[t.length-1].end<40&&(t[t.length-1].end-=40);let a={begin:n,end:c(i.getAttribute("end")),words:[],haveBg:!1,haveTranslation:!1,bg:{begin:0,end:0,words:[],haveTranslation:!1,translation:""},translation:"",agent:i.getAttribute("ttm:agent")||"default",index:0,isLine:!1,isWait:!1},l=[],d=i.children;if(a.begin-s>10*1e3&&t.push({begin:s+40,end:a.begin-40,words:[],haveBg:!1,haveTranslation:!1,bg:{begin:0,end:0,words:[],haveTranslation:!1,translation:""},translation:"",agent:"default",index:0,isLine:!1,isWait:!0}),s=a.end,d.length<1)l.push({text:i.textContent,begin:c(i.getAttribute("begin")),end:c(i.getAttribute("end")),isHeightLine:c(i.getAttribute("end"))-c(i.getAttribute("begin"))>1500});else for(let o=0;o<d.length;o++)switch(d[o].getAttribute("ttm:role")){case"x-bg":a.haveBg=!0;let m=[];if(a.bg.begin=c(d[o].getAttribute("begin")),a.bg.end=c(d[o].getAttribute("end")),a.bg.end>a.end&&(a.end=a.bg.end),a.bg.begin<a.begin&&(a.begin=a.bg.begin),d[o].children.length>0)for(let u=0;u<d[o].children.length;u++){const p=d[o].children[u];p.getAttribute("ttm:role")=="x-translation"?(a.bg.haveTranslation=!0,a.bg.translation=p.textContent):m.push({text:p.textContent,begin:c(p.getAttribute("begin")),end:c(p.getAttribute("end")),isHeightLine:c(p.getAttribute("end"))-c(p.getAttribute("begin"))>1500})}else m.push({text:d[o].textContent,begin:c(d[o].getAttribute("begin")),end:c(d[o].getAttribute("end")),isHeightLine:c(d[o].getAttribute("end"))-c(d[o].getAttribute("begin"))>1500});a.bg.words=m;break;case"x-translation":a.haveTranslation=!0,a.translation=d[o].textContent;break;case"x-roman":break;default:l.push({text:d[o].textContent,begin:c(d[o].getAttribute("begin")),end:c(d[o].getAttribute("end")),isHeightLine:c(d[o].getAttribute("end"))-c(d[o].getAttribute("begin"))>1500})}a.words=l,t.push(a)}for(let r=0;r<t.length;r++)t[r].index=r;return t}function c(g){if(!g)return 0;const[e,t,s]=g.split(/[:.]/).map(Number);if(isNaN(e)||isNaN(t)||isNaN(s))throw new Error("Invalid time format. Use 'MM:SS.mmm'");return e*60*1e3+t*1e3+s}class x{constructor(e,t,s,r){E(this,"addLyric",e=>{this.lyricsData[e].timers.forEach(i=>{clearTimeout(i)}),this.lyricsData[e].timers=[];const t=this.audio.currentTime*1e3;if(this.addIndex(e),this.lyricsData[e].haveBg&&(this.lyricsData[e].bg.dom.style.display="inherit",setTimeout(()=>{this.lyricsData[e].bg.dom.classList.add("bgShow"),setTimeout(()=>{this.gd(this.bubbleSort(this.nowPlayingIndex)[0])},50)},10)),this.isScrolling||y.to(this.lyricsData[e].parent,{duration:.5,scale:1.04,delay:this.nowPlayingIndex.length>1?0:.2}),this.lyricsData[e].isWait){const i=this.lyricsData[e].dom,n=this.lyricsData[e].end-t;this.lyricsData[e].dom.style.display="inherit";for(let a=0;a<3;a++)setTimeout(()=>{i.children[a].classList.add("watting_highlight")},n/3*a);this.animateScale({element:this.lyricsData[e].dom,totalTime:n,endTime:500,onComplete:()=>{this.lyricsData[e].dom.style.display="none"}})}this.gd(this.bubbleSort(this.nowPlayingIndex)[0]);const s=this.lyricsData[e].words,r=this.lyricsData[e].haveBg?this.lyricsData[e].bg.words:[];for(let i=0;i<s.length;i++){const n=s[i].begin-t,a=setTimeout(()=>{const l=(s[i].end-s[i].begin)*1.25;this.lyricsData[e].words[i].isHeightLine||y.to(this.lyricsData[e].words[i].dom,{duration:l/1e3,"--p":"100%","--rp":"140%",ease:"none"});const d=s[i].end-s[i].begin,o=this.lyricsData[e].words[i].dom.animate([{transform:this.lyricsData[e].words[i].dom.style.transform},{transform:"translateY(5px)"}],{duration:d>1?d+500:1500,easing:"ease-out",delay:50});if(o.onfinish=()=>{this.lyricsData[e].words[i].dom.style.transform="translate(0px, 5px)"},this.lyricsData[e].words[i].isHeightLine){console.log("\u6B4C\u8BCD\u9AD8\u4EAE\u7EBF");const m=this.lyricsData[e].words[i].dom;for(let u=0;u<m.children.length;u++){const p=m.children[u];m.children.length/l*1e3;const j=p.animate([{transform:"scale(1) translateY(0px)",easing:"cubic-bezier(0.5, 0, 0.5, 1)",color:"rgba(255, 255, 255, 0.2)",filter:"blur(0px)"},{transform:"scale(120%) translateY(-10%)",textShadow:"#ffffff 0px 0px 20px",easing:"cubic-bezier(0.5, 0, 0.5, 1)",color:"rgba(255, 255, 255, 1)",filter:"blur(1px)"},{transform:"scale(1) translateY(0px)",textShadow:"none",easing:"cubic-bezier(0.5, 0, 0.5, 1)",color:"rgba(255, 255, 255,1)",filter:"blur(0px)"}],{duration:this.isEnglishOrSymbol(s[i].text)?l:l*1.5,easing:"cubic-bezier(0.5, 0, 0.5, 1)",delay:(u-1)*.3*l/m.children.length,fill:"forwards"});this.lyricsData[e].animates.anime.push(j)}}},n*.95);this.lyricsData[e].timers.push(a)}for(let i=0;i<r.length;i++)setTimeout(()=>{const n=(r[i].end-r[i].begin)*1.25;y.to(this.lyricsData[e].bg.words[i].dom,{duration:n/1e3,"--p":"100%","--rp":"140%",ease:"none"});const a=r[i].end-r[i].begin,l=this.lyricsData[e].bg.words[i].dom.animate([{transform:"translateY(10px)"},{transform:"translateY(7px)"}],{duration:a>1?a+500:1500,easing:"ease-out"});l.onfinish=()=>{this.lyricsData[e].bg.words[i].dom.style.transform="translate(0px, 7px)"}},(r[i].begin-this.lyricsData[e].begin)*.95)});E(this,"removeLyric",e=>{if(this.removeIndex(e),this.lyricsData[e].timers.forEach(t=>{clearTimeout(t)}),this.lyricsData[e].timers=[],this.lyricsData[e].isWait){this.lyricsData[e].dom.style.display="none";for(let t=0;e<3;e++)this.lyricsData[t].dom.children[e].classList.remove("watting_highlight")}});this.audio=e,this.lyricsData=t,this.lyricsMainDom=s,this.lyricsContainer=document.createElement("div"),this.lyricsMainDom.appendChild(this.lyricsContainer),this.settings=Object.assign({lineHeight:0,nowPlayingOffset:window.innerHeight/5,innerHeightShowItemNum:10,scrollSpeed:1.2,blurNum:1},r),this.nowPlayingIndex=[],this.isScrolling=!1,this.scrollTimer=null,this.lyricsContainerY=0,this.meanHeight=0}init(){for(let e=0;e<this.lyricsData.length;e++)this.lyricsData[e].timers=[],this.lyricsData[e].animates={gsap:[],anime:[]},this.lyricsData[e].top=0;this.lyricsMainDom.addEventListener("wheel",e=>{this.isScrolling=!0,e.preventDefault(),console.log(e.deltaY),this.lyricsContainerY-=e.deltaY,this.lyricsContainer.style.transform=`translateY(${this.lyricsContainerY}px)`;for(let t=0;t<this.lyricsData.length;t++)this.lyricsData[t].parent.style.filter="blur(0px)",this.lyricsData[t].parent.style.transform=`translate(0,${this.lyricsData[t].top}px)`,this.lyricsData[t].parent.style.contentVisibility="auto";this.scrollTimer&&clearTimeout(this.scrollTimer),this.scrollTimer=setTimeout(()=>{this.isScrolling=!1},1e3)})}renderLyrics(){let e=0;for(let t=0;t<this.lyricsData.length;t++){const s=document.createElement("div");s.classList.add("lyric_item"),s.addEventListener("click",()=>{this.audio.currentTime=(this.lyricsData[t].begin-20)/1e3}),s.addEventListener("mousedown",i=>{this.isScrolling||y.to(s,{duration:.7,scale:.95,ease:"elastic.out(1, 0.6)"})}),s.addEventListener("mouseup",i=>{this.isScrolling||y.to(s,{duration:.7,scale:1,ease:"elastic.out(1, 0.6)"})}),s.addEventListener("mouseleave",i=>{this.isScrolling||this.isPlaying(t)||y.to(s,{duration:.7,scale:1,ease:"elastic.out(1, 0.6)"})});const r=document.createElement("div");if(r.classList.add("main_lrc"),this.lyricsData[t].isWait){r.classList.add("watting");for(let i=0;i<3;i++){const n=document.createElement("div");n.classList.add("watting_item"),r.style.display="none",r.appendChild(n),s.style.left="20px"}}for(let i=0;i<this.lyricsData[t].words.length;i++){const n=document.createElement("div");if(n.style.setProperty("--color","0.2"),n.style.transform="translateY(10px)",n.classList.add("char"),this.lyricsData[t].words[i].isHeightLine){for(let o=0;o<this.lyricsData[t].words[i].text.length;o++){const m=document.createElement("div");m.classList.add("hl_text"),m.innerText=this.lyricsData[t].words[i].text[o],n.appendChild(m)}const a=n.children,l=Math.floor(a.length/2),d=a.length;for(let o=0;o<d;o++){const m=o;let u;m<l?u=100-50*m/l:u=50-50*(m-l)/(d-l),n.children[o].style.transformOrigin=`${u}% 50%`}}else n.innerText=this.lyricsData[t].words[i].text,n.style.setProperty("--p","-40%"),n.style.setProperty("--rp","0%"),n.style.setProperty("--rcolor","1");this.isEnglishOrSymbol(this.lyricsData[t].words[i].text)&&(n.style.marginRight="2%"),r.appendChild(n),this.lyricsData[t].words[i].dom=n}if(s.appendChild(r),this.lyricsData[t].haveTranslation){const i=document.createElement("div");i.classList.add("translation"),i.innerHTML=this.lyricsData[t].translation,s.appendChild(i)}if(this.lyricsData[t].haveBg){const i=document.createElement("div");i.classList.add("bg");const n=document.createElement("div");n.classList.add("text");for(let a=0;a<this.lyricsData[t].bg.words.length;a++){const l=document.createElement("div");if(l.classList.add("char"),l.style.setProperty("--p","-40%"),l.style.setProperty("--rp","0%"),l.style.setProperty("--color","0.2"),l.style.setProperty("--rcolor","1"),l.style.transform="translateY(10px)",this.lyricsData[t].bg.words[a].isHeightLine){for(let d=0;d<this.lyricsData[t].bg.words[a].text.length;d++){const o=document.createElement("span");o.classList.add("hl_text"),o.innerText=this.lyricsData[t].bg.words[a].text[d],l.appendChild(o)}l.style.marginLeft="20px",l.style.marginRight="20px"}else l.innerText=this.lyricsData[t].bg.words[a].text;this.isEnglishOrSymbol(this.lyricsData[t].bg.words[a].text)&&(l.style.marginRight="2%",l.innerHTML+=" "),n.appendChild(l),this.lyricsData[t].bg.words[a].dom=l}if(i.appendChild(n),this.lyricsData[t].bg.haveTranslation){const a=document.createElement("div");a.classList.add("translation"),a.innerHTML=this.lyricsData[t].bg.translation,i.appendChild(a)}s.appendChild(i),this.lyricsData[t].bg.dom=i}this.lyricsData[t].agent!="default"&&(+this.lyricsData[t].agent.split("v")[1]%2!=0?(s.style.left="10px",s.style.right="auto",s.style.transformOrigin="center left"):(s.classList.add("right"),s.style.left="auto",s.style.right="15px",s.style.transformOrigin="center right")),this.lyricsData[t].parent=s,this.lyricsData[t].dom=r}for(let t=0;t<this.lyricsData.length;t++)this.lyricsData[t].haveBg&&this.lyricsData[t].parent.appendChild(this.lyricsData[t].bg.dom),this.lyricsContainer.appendChild(this.lyricsData[t].parent),setTimeout(()=>{const s=this.getTopHeight(1,t,this.lyricsData)+this.settings.nowPlayingOffset;this.lyricsData[t].parent.style.transform=`translate(0,${s}px)`,this.lyricsData[t].top=s},1e3),e+=this.lyricsData[t].parent.offsetHeight;this.meanHeight=e/this.lyricsData.length}getTopHeight(e,t){const s=this.lyricsData;let r=0;if(t>e)for(let i=e;i<t;i++){const n=s[i].parent.offsetHeight+this.settings.lineHeight;n===20?r+=s[i].isWait?0:this.meanHeight:r+=n}else for(let i=e;i>t;i--){const n=s[i-1].parent.offsetHeight+this.settings.lineHeight;n===20?r-=s[i-1].isWait?0:this.meanHeight:r-=n}return r+this.settings.nowPlayingOffset}isPlaying(e){return this.nowPlayingIndex.includes(e)}addIndex(e){this.nowPlayingIndex.includes(e)||this.nowPlayingIndex.push(e)}removeIndex(e){const t=this.nowPlayingIndex.indexOf(e);t>-1&&this.nowPlayingIndex.splice(t,1)}gd(e){this.lyricsData.forEach(t=>{this.isPlaying(t.index)?t.parent.style.filter="blur(0px)":(this.isScrolling||(t.parent.style.filter=`blur(${Math.abs(t.index-e)*this.settings.blurNum}px)`),t.haveBg&&(t.bg.dom.classList.remove("bgShow"),t.bg.dom.style.display="none"),this.isPlaying(e)&&setTimeout(()=>{this.isScrolling||y.to(t.parent,{duration:.5,scale:1,delay:0}),this.lyricsData[t.index].animates.anime.forEach(n=>{n.cancel()}),this.lyricsData[t.index].animates.anime=[],t.words.forEach(n=>{if(y.to(n.dom,{duration:.2,"--rcolor":.2,onComplete:()=>{n.dom.style.setProperty("--p","-40%"),n.dom.style.setProperty("--rp","0%"),n.dom.style.setProperty("--rcolor","1")}}),n.isHeightLine){const l=n.dom.children;for(let d=0;d<l.length;d++)l[d].style.color="rgba(255,255,255,0.2)"}const a=n.dom.animate([{transform:n.dom.style.transform},{transform:"translateY(10px)"}],{duration:500,easing:"ease-in"});a.onfinish=()=>{n.dom.style.transform="translateY(10px)"}}),t.bg.words.forEach(n=>{y.to(n.dom,{duration:.2,"--rcolor":.2,onComplete:()=>{n.dom.style.setProperty("--p","-40%"),n.dom.style.setProperty("--rp","0%"),n.dom.style.setProperty("--rcolor","1")}});const a=n.dom.animate([{transform:n.dom.style.transform},{transform:"translateY(10px)"}],{duration:500,easing:"ease-in"});a.onfinish=()=>{n.dom.style.transform="translateY(10px)"}})},100));const s=Math.abs(e-3-t.index),r=s*70-s*20,i=e-t.index;this.isScrolling||(this.lyricsContainerY=0,this.lyricsContainer.style.transform="translateY(0px)",this.lyricsData[t.index].top=this.getTopHeight(e,t.index),i>-this.settings.innerHeightShowItemNum&&i<this.settings.innerHeightShowItemNum?setTimeout(()=>{y.to(t.parent,{duration:this.settings.scrollSpeed,ease:"elastic.out(1, 1.35)",y:this.lyricsData[t.index].top})},r):y.to(t.parent,{duration:0,y:this.lyricsData[t.index].top}),setTimeout(()=>{i>-this.settings.innerHeightShowItemNum&&i<this.settings.innerHeightShowItemNum?t.parent.style.contentVisibility="auto":t.parent.style.contentVisibility="hidden"},100))})}animateScale({element:e,totalTime:t,endTime:s,onComplete:r}){if(!e||!t||!s||typeof r!="function")throw new Error("Invalid arguments. Please provide element, totalTime, endTime, and onComplete callback.");const i=2500,n="power1.inOut";let a=!1;y.to(e,{scale:1.5,duration:i/1e3,ease:n,repeat:-1,yoyo:!0,onRepeat:()=>{a&&(y.killTweensOf(e),r())}}),y.to(e,{scale:0,duration:s/1e3,ease:n,delay:t/1e3-s/1e3,onComplete:()=>{a=!0}})}isEnglishOrSymbol(e){return/^[A-Za-z0-9!-/:-@[-`{-~]+$/.test(e)}bubbleSort(e){for(var t=0;t<e.length-1;t++)for(var s=0;s<e.length-t-1;s++)if(e[s]>e[s+1]){var r=e[s];e[s]=e[s+1],e[s+1]=r}return e}}const h=document.getElementById("audio"),v=document.querySelectorAll("#bgimg"),S=new URLSearchParams(window.location.search),b=S.get("m")||"ME!",Y=S.get("t")||"mp3";h.src="./music/"+b+"."+Y,v.forEach(g=>{g.src="./music/"+b+".png"});const N=document.getElementById("title");N.innerText=b;const O=document.getElementById("titlem");O.innerText=b;const k=document.getElementById("author");k.innerText=b;const $=document.getElementById("authorm");$.innerText=b;const W=document.getElementById("current"),R=document.getElementById("residue"),C=document.getElementById("playBtn"),P=document.getElementById("stopBtn"),_=document.getElementById("ctrl_btn"),L=document.querySelector(".range"),I=document.querySelector(".light");let T=!1;L.addEventListener("mousedown",function(g){T=!0,B(g),document.addEventListener("mousemove",H),document.addEventListener("mouseup",A)});function H(g){T&&B(g)}function A(){T=!1,document.removeEventListener("mousemove",H),document.removeEventListener("mouseup",A)}function B(g){const e=L.getBoundingClientRect();let t=g.clientX-e.left;t=Math.max(0,Math.min(t,e.width));const s=t/e.width*100;I.style.width=s+"%",h.currentTime=t/e.width*h.duration}function z(g,e){L.getBoundingClientRect();const t=g/e*100;I.style.width=t+"%"}function q(g){const e=g.currentTime,t=g.duration,s=Math.floor(e/60),r=Math.floor(e%60),i=Math.floor(t/60),n=Math.floor(t%60);W.innerText=`${s}:${r<10?"0"+r:r}`,R.innerText=`${i}:${n<10?"0"+n:n}`}window.toggleMode=function(){h.paused?h.play():h.pause()},_.addEventListener("click",function(){h.paused?h.play():h.pause()}),h.addEventListener("timeupdate",function(){q(h),z(h.currentTime,h.duration)}),h.addEventListener("play",function(){C.style.display="block",P.style.display="none",v[1].style.transform="scale(1)"}),h.addEventListener("pause",function(){C.style.display="none",P.style.display="block",v[1].style.transform="scale(0.7)"});let D=f(await fetch("./music/"+b+".ttml").then(g=>g.text()));console.log(D);const V=document.getElementById("lyrics"),M=new Go;async function U(){const g=await(await fetch("main.wasm")).arrayBuffer(),{instance:e}=await WebAssembly.instantiate(g,M.importObject);M.run(e)}U();const w=new x(h,D,V);w.init(),w.renderLyrics(),window.addLyric=w.addLyric,window.removeLyric=w.removeLyric,setInterval(()=>{h.paused||highlightLyricsW(D,h.currentTime*1e3)},20),console.log("initLyrics",D),h.addEventListener("seeking",()=>{w.nowPlayingIndex=[]}),h.addEventListener("ended",async()=>{h.currentTime=0,h.play()}),document.addEventListener("keydown",g=>{g.key===" "&&(h.paused?h.play():h.pause()),g.key==="ArrowLeft"&&(h.currentTime-=5),g.key==="ArrowRight"&&(h.currentTime+=5)})})();
